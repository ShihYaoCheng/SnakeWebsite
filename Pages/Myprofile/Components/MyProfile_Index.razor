@page "/myprofile"
@using SnakeAsianLeague.Data.Services
@using SnakeAsianLeague.Data.Services.Backstage

@using SnakeAsianLeague.Data.Entity.Backstage
@using Microsoft.AspNetCore.Components.Forms
@using SnakeAsianLeague.Data.Services.Interface
@using SnakeAsianLeague.Data.Services.Metamask
@using SnakeAsianLeague.Data.Services.SnakeServerService
@using SnakeAsianLeague.Data.Entity.SnakeServer
@using System.Security.Claims

@using SnakeAsianLeague.Pages.Myprofile.Components.Index_Components

@inject IJSRuntime JS
@inject AppState AppState
@inject ProfileService ProfileService
@inject IEthereumHostProvider _metamaskHostProvider
@inject NFTService NFTService
@inject AuthenticationStateProvider AuthenticationStateProvider



@implements IDisposable

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="css/Myaccount.css" rel="stylesheet" />
    <link href="css/Myprofile.css" rel="stylesheet" />
    <link href="css/Sidebar.css" rel="stylesheet" />
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <title>PonPonSnake 碰碰蛇｜MyPage Account</title>
</head>

<AuthorizeView>
    <Authorized>
    <div>
        <MyprofileSidebar /> 

        @* <aside class="myprofileSidebar">
            <div class="myprofileSidebarButton">
                <img src="/images/Myprofile/sidebarLine.png" alt="">
            </div>
            <div class="myprofileSidebarBlock">
                <div class="accountManagement">Account<br>Management</div>
                <ul class="accountManagementUl">
                    <a href="myprofile#Account" id="accountManagementUl-Account" class="current_page"><li data-i18n="Sidebar.Account">Account</li></a>
                    <a href="mymatch" id="accountManagementUl-eSport"><li data-i18n="Sidebar.Esports">eSport</li></a>
                    <a href="myawardnotice" id="accountManagementUl-Reward"><li data-i18n="Sidebar.Reward">Reward</li></a>
                </ul>
            </div>
        </aside> *@

        <main class="myprofileMain">

            <div class="myprofileBlock" id="Account">
                <div class="myprofileBlockTitle" data-i18n="myprofile.account">Account</div>
                <div class="myprofileArea">

                    <div class="informationBackground">
                        <div class="informationDetailOriginal">
                            <div class="personalBlock">
                                <img class="personaAvatar" src="/images/Myprofile/user_icon.png" alt="">

                                <button id="editButton" @onclick="EditProfileButtonOnClick">
                                    <img src="/images/Myprofile/edit_icon.png" alt="">
                                    <span data-i18n="myprofile.edit">Edit</span>
                                </button>
                            </div>

                            <div class="personalInformation">
                                <div class="playerNickname">@AppState.LoginStatus.name</div>
                                <div class="playerInfoRow">
                                    <div class="playerInfoRowTitle" data-i18n="myprofile.gameID">Game ID</div>
                                    <div class="playerInfoRowShow">@AppState.LoginStatus.userID</div>
                                </div>
                                <div class="playerInfoRow">
                                    <div class="playerInfoRowTitle" data-i18n="myprofile.phone">Phone</div>
                                    <div class="playerInfoRowShow">@AppState.LoginStatus.phone</div>
                                </div>

                                @if (!MetamaskAvailable)
                                {

                                    <button class="btnMetamask" disabled>
                                        <a href="https://chrome.google.com/webstore/detail/metamask/nkbihfbeogaeaoehlefnkodbefgpgknn" target="_blank">
                                            <span style="margin: 5px 20px;" data-i18n="myprofile.installMetamask">Please Install Metamask</span>
                                        </a>
                                    </button>

                                }
                                else if (MetamaskAvailable && string.IsNullOrEmpty(AppState.LoginStatus.walletAddress))
                                {
                                    <button type="button" class="btnMetamask" @onclick="@EnableEthereumAsync">
                                        <span data-i18n="myprofile.connectMetamask">Connect Metamask</span>
                                        <img src="/images/Myprofile/btnMetamask_icon.png" alt="">
                                    </button>

                                }
                            </div>
                        </div>

                        @if (MetamaskAvailable && !string.IsNullOrEmpty(AppState.LoginStatus.walletAddress))
                        {
                            <div class="metamaskAvailable" title="點擊複製 Address" @onclick="textCopyClick">
                                Address：<span>@AppState.LoginStatus.walletAddress</span>
                                <div id="copyTip">複製成功</div>
                            </div>
                        }

                    </div>
                </div>
            </div>

            @if (MetamaskAvailable && !string.IsNullOrEmpty(AppState.LoginStatus.walletAddress))
            {
                <div class="myprofileBlock" id="Asset">
                    <div class="myprofileBlockTitle" data-i18n="myprofile.asset">Asset</div>

                    <div class="myprofileArea">
                        <div class="informationAssetBlockAll">
                            <div class="informationAssetBlock">
                                <a href="myprofile">
                                    <div class="assetItem">
                                        <img class="assetIcon" src="/images/Myprofile/ERNC.png" alt="">
                                        <span>ERNC</span>
                                    </div>
                                    <div class="assetValue">0</div>
                                </a>
                            </div>

                            <div class="informationAssetBlock">
                                <a href="myprofile">
                                    <div class="assetItem">
                                        <img class="assetIcon" src="/images/Myprofile/MIPR.png" alt="">
                                        <span>MIPR</span>
                                    </div>
                                    <div class="assetValue">0</div>
                                </a>
                            </div>

                            <div class="informationAssetBlock">
                                <a href="myprofile">
                                    <div class="assetItem">
                                        <img class="assetIcon" src="/images/Myprofile/SRC.png" alt="">
                                        <span>SRC</span>
                                    </div>
                                    <div class="assetValue">0</div>
                                </a>
                            </div>

                            <div class="informationAssetBlock">
                                @* <a href="Inventory"> *@
                                <a href="myprofile">
                                    <div class="assetItem">
                                        <img class="assetIcon" src="/images/Myprofile/Knight.png" alt="">
                                        <span>Rider</span>
                                    </div>
                                    <div class="assetValue">0</div>
                                </a>
                            </div>
                            <div class="informationAssetBlock" id="informationAssetBlock-Lock">
                                <div class="assetItem">
                                    <img class="ICON_Lock"  src="/images/Myprofile/ICON_Lock.png" alt="">
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>

                @* <div class="myprofileBlock" id="Activities">
                    <div class="myprofileBlockTitle" data-i18n="myprofile.activities">Activities</div>
                    <div class="myprofileArea">
                        <div class="ActivitiesRow">
                            <span>XXXXXXXXXXXXXX</span>
                        </div>
                    </div>
                    <div class="myprofileArea">
                        <div class="ActivitiesRow">
                            <span>XXXXXXXXXXXXXX</span>
                        </div>
                    </div>
                    <div class="myprofileArea">
                        <div class="ActivitiesRow">
                            <span>XXXXXXXXXXXXXX</span>
                        </div>
                    </div>
                </div> *@
            }
        </main>
    </div>
    </Authorized>
    <NotAuthorized>
        <div class="myprofileLogin">
            <h1>Please Login First</h1>
        </div>
    </NotAuthorized>
</AuthorizeView>







<!-- 編輯個人資料-->
@*<Index_edit />

<!-- 彈窗提示-->
<Index_Pop displayPopupWindow=@displayPopupWindow  PopupWindowTitle=@PopupWindowTitle PopupWindowContent=@PopupWindowContent successWindowClose="successWindowClose" />
*@


@code {



    //編輯個人資料

    private Profile profile = new Profile();

    bool displayEditProfileWindow = false;

    char selectedGender = 'a';

    bool selectedBeInterviewed;

    bool selectedOpenAwardInfo;



    //Metamask

    bool MetamaskAvailable { get; set; }

    string SelectedAccount { get; set; }

    protected string AuthenticatedAccount { get; set; }
    //彈窗
    bool displayPopupWindow = false;
    string PopupWindowTitle = "";
    string PopupWindowContent = "";


    //private ClaimsPrincipal LoginUser;


    protected override async Task OnInitializedAsync()
    {
        AppState.StateChanged += async (Source, Property)
        => await InvokeAsync(StateHasChanged);
        _metamaskHostProvider.SelectedAccountChanged += MetamaskHostProvider_SelectedAccountChanged;

        displayEditProfileWindow = false;
        //var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        //LoginUser = authState.User;

    }



    void IDisposable.Dispose()
    {
        AppState.StateChanged -= async (Source, Property)
        => await InvokeAsync(StateHasChanged);
        _metamaskHostProvider.SelectedAccountChanged -= MetamaskHostProvider_SelectedAccountChanged;

    }



    private async Task AppState_StateChanged(ComponentBase Source, string Property)
    {

        if (Source != this)
        {

            await InvokeAsync(StateHasChanged);

        }



    }



    private async Task EditProfileButtonOnClick()
    {
        //uint userid = Convert.ToUInt32( LoginUser.FindFirst("UserID")?.Value);
        //Profile p = await ProfileService.GetOneProfileByUserId(userid);

        Profile p = await ProfileService.GetOneProfileByUserId((uint)AppState.LoginStatus.userID);

        if (p != null)
        {

            profile = p;



            selectedGender = p.Gender.Value;

            selectedBeInterviewed = p.BeInterviewed;

            selectedOpenAwardInfo = p.OpenAwardInfo;

        }
        else
        {
            selectedBeInterviewed = true;
            selectedOpenAwardInfo = true;
        }

        displayEditProfileWindow = true;

    }



    private async Task EditProfileSubmit()
    {

        //profile.UserName = LoginUser.FindFirst("Name")?.Value;

        profile.UserName = AppState.LoginStatus.name;

        profile.UserId = (uint)AppState.LoginStatus.userID;

        profile.Phone = AppState.LoginStatus.phone;



        profile.Gender = selectedGender;

        profile.BeInterviewed = selectedBeInterviewed;

        profile.OpenAwardInfo = selectedOpenAwardInfo;



        Profile p = await ProfileService.GetOneProfileByUserId((uint)AppState.LoginStatus.userID);

        if (p == null)
        {

            await ProfileService.InsertProfile(profile);

        }
        else
        {

            await ProfileService.UpdateProfile(profile);

        }
        displayEditProfileWindow = false;


    }




    private async Task textCopyClick()
    {
        await JS.InvokeVoidAsync("textCopy");
        await JS.InvokeVoidAsync("copyTip");
    }




    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {




            MetamaskAvailable = await _metamaskHostProvider.CheckProviderAvailabilityAsync();

            StateHasChanged();

            @* await JS.InvokeVoidAsync("myprofileSidebar"); *@
            await JS.InvokeVoidAsync("installI18n");
            await JS.InvokeVoidAsync("afterRender");
        }

    }



    private async Task MetamaskHostProvider_SelectedAccountChanged(string account)
    {

        SelectedAccount = account;

        this.StateHasChanged();

    }



    protected async Task EnableEthereumAsync()
    {

        SelectedAccount = await _metamaskHostProvider.EnableProviderAsync();

        ServerResponce responce = await NFTService.PostNFTWalletAddress(AppState.LoginStatus.userID, SelectedAccount);
        

        //提示訊息
        if (responce.Success && responce.Content == "綁定成功")
        {
            AppState.LoginStatus.walletAddress = SelectedAccount;
            PopupWindowTitle = responce.Content;
            PopupWindowContent = "";

            displayPopupWindow = true;
            await JS.InvokeVoidAsync("installI18n");
        }else if (responce.Success && responce.Content == "已綁定")
        {
            AppState.LoginStatus.walletAddress = SelectedAccount;
            PopupWindowTitle = responce.Content;
            PopupWindowContent = "";

            displayPopupWindow = true;
            await JS.InvokeVoidAsync("installI18n");
            Console.WriteLine(responce.Content);
        }
        else
        {
            PopupWindowTitle = "綁定失敗";
            PopupWindowContent = responce.Content;
            SelectedAccount = "";
            displayPopupWindow = true;
        }

    }


    private void successWindowClose()
    {
        displayPopupWindow = false;
    }


}
