@page "/Myaccount"

@using SnakeAsianLeague.Data.Services
@using SnakeAsianLeague.Data.Services.Backstage 

@using SnakeAsianLeague.Data.Entity.Backstage
@using Microsoft.AspNetCore.Components.Forms


@inject IJSRuntime JS
@inject AppState AppState
@inject ProfileService ProfileService




@implements IDisposable

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="css/Myaccount.css" rel="stylesheet" />
    <link href="css/MyPage.css" rel="stylesheet" />
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <title>PonPonSnake 碰碰蛇｜會員主頁</title>
</head>

@if (!AppState.LoginStatus.IsLogin)
{
    <div class="myaccount_login">

        <h1>Please Login First</h1>
    </div>
}
else
{

    <div class="myaccount_block">
     
        <div class="personal_information">
            <div class="mypage">個人資訊</div>
            <div class="info_detail">
                <div class="info_icon">
                    <img src="/images/Myaccount/user_icon.webp" alt="">
                </div>

                <div class="information">
                    <div class="info_row">
                        <div class="info_row_title">遊戲暱稱</div>
                        <div class="info_row_show" id="info_name">@AppState.LoginStatus.name</div>
                    </div>
                    <div class="info_row">
                        <div class="info_row_title">遊戲ID</div>
                        <div class="info_row_show" id="info_ID">@AppState.LoginStatus.userID</div>
                    </div>
                    <div class="info_row">
                        <div class="info_row_title">手機號碼</div>
                        <div class="info_row_show" id="info_phone">@AppState.LoginStatus.phone</div>
                    </div>

                    <div class="" id="edit_row" @onclick="EditProfileButtonOnClick">
                        <div id="edit_icon">
                            <span>編輯個人資訊</span>
                            <img src="/images/Myaccount/edit_icon.webp" alt="">
                        </div>
                    </div>
                </div>
            </div>
        </div>


        


        


    </div>


    <!-- 編輯個人資料-->
    <div class="window @(displayEditProfileWindow ? "window_open" : "")" id="edit_info_window">

        <div class="window_bg" id="edit_info">

            <svg xmlns="http://www.w3.org/2000/svg" width="24.122" height="24.12" viewBox="0 0 24.122 24.12"
                 class="window_close" id="edit_info_close" @onclick="()=> displayEditProfileWindow = false">
                <path id="" data-name="合体 5" d="M-12484-1752l-11,11,11-11-11-11,11,11,11-11-11,11,11,11Z"
                      transform="translate(12496.062 1764.06)" fill="none" stroke="#e0eeff" stroke-linecap="round"
                      stroke-linejoin="round" stroke-width="3" />
            </svg>

            <div class="window_title">
                <p>個人資料編輯</p>
            </div>


            <EditForm Model="@profile" class="window_input_block">
                <DataAnnotationsValidator />
                <ValidationSummary />



                <div class="form_row only_show_row">
                    <div class="window_row_title only_show_title">遊戲暱稱</div>
                    <div class="window_row_show only_show_input" id="edit_name">@AppState.LoginStatus.name</div>
                </div>

                <div class="form_row only_show_row">
                    <div class="window_row_title only_show_title">遊戲ID</div>
                    <div class="window_row_show only_show_input" id="edit_ID">@AppState.LoginStatus.userID</div>
                </div>
                <div class="form_row only_show_row">
                    <div class="window_row_title only_show_title">手機號碼</div>
                    <div class="window_row_show only_show_input" id="edit_phone">@AppState.LoginStatus.phone</div>
                </div>

                

                <div class="form_row">
                    <label class="window_row_title" for="edit_realname">姓名</label>
                    <div class="window_row_show">
                        <input type="text" class="window_input" id="edit_realname" name="edit_realname" placeholder=""
                               required @bind-value="profile.RealName">
                    </div>
                </div>

                <div class="form_row">
                    <label class="window_row_title title_long" for="">您是否願意接受賽事採訪？</label>
                    <div class="window_row_show radio_row_show">
                        <input type="radio" value="m" class="edit_radio" name="iterview" id="iterview_yes" 
                               checked="@(selectedBeInterviewed == true)" @onclick="()=>selectedBeInterviewed = true" />
                        <label for="iterview_yes" class="edit_label">願意</label>
                        <input type="radio" value="f" class="edit_radio" name="iterview" id="iterview_no"
                               checked="@(selectedBeInterviewed == false)" @onclick="()=>selectedBeInterviewed = false" />
                        <label for="iterview_no" class="edit_label edit_label2">不願意</label>

                    </div>

                </div>


                <div class="form_row">
                    <label class="window_row_title title_long" for="">您是否願意適度公開得獎資訊？</label>
                    <div class="window_row_show radio_row_show">
                        <input type="radio" value="m" class="edit_radio" name="public_info" id="public_info_yes"
                               checked="@(selectedOpenAwardInfo == true)" @onclick="()=>selectedOpenAwardInfo = true" />
                        <label for="public_info_yes" class="edit_label">願意</label>
                        <input type="radio" value="f" class="edit_radio" name="public_info" id="public_info_no"
                               checked="@(selectedOpenAwardInfo == false)" @onclick="()=>selectedOpenAwardInfo = false" />
                        <label for="public_info_no" class="edit_label edit_label2">不願意</label>

                    </div>

                </div>

                <div class="form_row multipleLines_row">
                    <label class="window_row_title multipleLines_label title_long" id="edit_idea" for="">對碰碰蛇的想法</label>
                    <div class="window_row_show">
                        <InputTextArea class="window_input_textarea" cols="30" rows="10" id="edit_idea"
                                       @bind-Value="profile.IdeaOfSnake"></InputTextArea>

                    </div>
                </div>

                <div class="form_row multipleLines_row title_long">
                    <label class="window_row_title multipleLines_label title_long" id="edit_suggest" for="">對亞洲聯賽的建議</label>
                    <div class="window_row_show">
                        <InputTextArea class="window_input_textarea" cols="30" rows="10" id="edit_suggest"
                                        @bind-Value="profile.Recommendation"></InputTextArea>
                    </div>
                </div>

                <div class="form_row">
                    <label class="window_row_title" for="edit_sns">FB / IG連結</label>
                    <div class="window_row_show">
                        <input type="text" class="window_input" id="edit_sns" name="edit_sns" placeholder=""
                               @bind-value="profile.Link">
                    </div>
                </div>


                <div class="form_row multipleLines_row">
                    <label class="window_row_title multipleLines_label" id="edit_content" for="">自我介紹</label>
                    <div class="window_row_show">
                        <InputTextArea class="window_input_textarea" cols="30" rows="10" id="edit_content"
                                       @bind-Value="profile.SelfIntroduction"></InputTextArea>

                    </div>
                </div>


                <div class="form_row">
                    <label class="window_row_title" for="">性別</label>
                    <div class="window_row_show radio_row_show">
                        <input type="radio" value="m" class="edit_radio" name="gender" id="male"
                               checked="@(selectedGender == 'm')" @onclick="()=>selectedGender = 'm'"/>
                        <label for="male" class="edit_label">男性</label>
                        <input type="radio" value="f" class="edit_radio" name="gender"  id="female"
                               checked="@(selectedGender == 'f')" @onclick="()=>selectedGender = 'f'"/>
                        <label for="female" class="edit_label edit_label2">女性</label>

                    </div>

                </div>

                <div class="form_row">
                    <label class="window_row_title" for="edit_birth_date">出生年月日</label>
                    <div class="window_row_show" >
                        <InputDate class="window_input" id="edit_birth_date" @bind-Value="profile.DateOfBirth"></InputDate>

                    </div>
                    
                    
                </div>

                <div class="form_row">
                    <label class="window_row_title" for="edit_email">Email</label>
                    <div class="window_row_show">
                        <input type="text" class="window_input" id="edit_email" name="edit_email" placeholder="" required
                               @bind-value="profile.Email">
                    </div>
                </div>

                <div class="form_row">
                    <label class="window_row_title" for="edit_city">城市</label>
                    <div class="window_row_show">
                        <input type="text" class="window_input" id="edit_city" name="" placeholder="" required
                               @bind-value="profile.City">
                    </div>
                </div>

                

                <div type="text" class="edit_error">紅框欄請填寫資訊</div>
                
                <div id="edit_info_window_submit"  class="window_submit" @onclick="EditProfileSubmit">

                    <img src="/images/Index/signUpEvent_button.webp" alt="">
                    <span>儲存</span>

                </div>
            </EditForm>


        </div>
    </div>




}



@code {

    //編輯個人資料
    private Profile profile = new Profile();
    bool displayEditProfileWindow = false;
    char selectedGender = 'a';
    bool selectedBeInterviewed;
    bool selectedOpenAwardInfo;



    protected override async Task OnInitializedAsync()
    {
        AppState.StateChanged += async (Source, Property)
        => await InvokeAsync(StateHasChanged);


        displayEditProfileWindow = false;
    }

    void IDisposable.Dispose()
    {
        AppState.StateChanged -= async (Source, Property)
        => await InvokeAsync(StateHasChanged);
    }

    private async Task AppState_StateChanged(ComponentBase Source, string Property)
    {
        if (Source != this)
        {
            await InvokeAsync(StateHasChanged);
        }

    }

 

    private async Task EditProfileButtonOnClick()
    {
        Profile p = await ProfileService.GetOneProfileByUserId((uint)AppState.LoginStatus.userID);

        if (p != null)
        {
            profile = p;

            selectedGender = p.Gender.Value;
            selectedBeInterviewed = p.BeInterviewed;
            selectedOpenAwardInfo = p.OpenAwardInfo;
        }
        else
        {
            selectedBeInterviewed = true;
            selectedOpenAwardInfo = true;
        }
        displayEditProfileWindow = true;
    }


    private async Task EditProfileSubmit()
    {
        profile.UserName = AppState.LoginStatus.name;
        profile.UserId = (uint)AppState.LoginStatus.userID;
        profile.Phone = AppState.LoginStatus.phone;

        profile.Gender = selectedGender;
        profile.BeInterviewed = selectedBeInterviewed;
        profile.OpenAwardInfo = selectedOpenAwardInfo;

        Profile p = await ProfileService.GetOneProfileByUserId((uint)AppState.LoginStatus.userID);
        if (p == null)
        {
            await ProfileService.InsertProfile(profile);
        }
        else
        {
            await ProfileService.UpdateProfile(profile);
        }

        displayEditProfileWindow = false;

 
    }




    protected override async Task OnAfterRenderAsync(bool firstRender)

    {   
        if(firstRender){
            await JS.InvokeVoidAsync("afterRender");
        }
    }
}
